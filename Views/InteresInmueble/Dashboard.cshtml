@{
    ViewData["Title"] = "Gestion de Interesados";
    var estadisticas = ViewBag.Estadisticas as Dictionary<string, int>;
    var interesesRecientes = ViewBag.InteresesRecientes as List<Inmobiliaria_troncoso_leandro.Models.InteresInmueble>;
    var interesesUrgentes = ViewBag.InteresesUrgentes as List<Inmobiliaria_troncoso_leandro.Models.InteresInmueble>;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Gestionar de Interesados
                    </h2>
                    <p class="text-muted">Visión general de los intereses en inmuebles</p>
                </div>
                <div>
                    <a asp-action="Index" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i>
                        Ver Lista Completa
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total de Intereses
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @estadisticas?.GetValueOrDefault("Total", 0)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Intereses Hoy
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @estadisticas?.GetValueOrDefault("Hoy", 0)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Intereses Urgentes -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Intereses Urgentes (+ de 3 días)
                    </h6>
                    <span class="badge bg-white text-danger">@interesesUrgentes?.Count</span>
                </div>
                <div class="card-body">
                    @if (interesesUrgentes?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Inmueble</th>
                                        <th>Días</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var urgente in interesesUrgentes.Take(5))
                                    {
                                        <tr>
                                            <td>
                                                <div class="fw-bold">@urgente.Nombre</div>
                                                <small class="text-muted">@urgente.Email</small>
                                            </td>
                                            <td>
                                                <div class="small">@urgente.Inmueble?.Direccion</div>
                                            </td>
                                            <td>
                                                <span class="badge bg-danger">@urgente.DiasDesdeInteres</span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                                            onclick="marcarContactadoRapido(@urgente.IdInteres)" title="Marcar contactado">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <a asp-action="Details" asp-route-id="@urgente.IdInteres" 
                                                       class="btn btn-outline-info btn-sm" title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (interesesUrgentes.Count > 5)
                        {
                            <div class="text-center">
                                <a asp-action="Index" asp-route-estado="pendiente" asp-route-fechaHasta="@DateTime.Now.AddDays(-3).ToString("yyyy-MM-dd")" 
                                   class="btn btn-sm btn-danger">
                                    Ver todos los urgentes (@interesesUrgentes.Count)
                                </a>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-thumbs-up fa-2x text-success mb-2"></i>
                            <div class="text-muted">¡Excelente! No hay intereses urgentes</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Intereses Recientes -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-clock me-2"></i>
                        Intereses Recientes
                    </h6>
                    <span class="badge bg-white text-primary">@interesesRecientes?.Count</span>
                </div>
                <div class="card-body">
                    @if (interesesRecientes?.Any() == true)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var reciente in interesesRecientes.Take(8))
                            {
                                <div class="list-group-item px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">@reciente.Nombre</div>
                                            <div class="small text-muted">@reciente.Email</div>
                                            <div class="small text-primary">@reciente.Inmueble?.Direccion</div>
                                            <div class="small text-muted">@reciente.Fecha.ToString("dd/MM/yyyy HH:mm")</div>
                                        </div>
                                        <div class="text-end">
                                            @if (reciente.Contactado)
                                            {
                                                <span class="badge bg-success mb-1">Contactado</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning mb-1">Pendiente</span>
                                            }
                                            <div>
                                                <a asp-action="Details" asp-route-id="@reciente.IdInteres" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <div class="text-muted">No hay intereses recientes</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y Estadísticas Adicionales -->
    <div class="row">
        <!-- Progreso de Contactos -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-chart-pie me-2"></i>
                        Progreso de Contactos
                    </h6>
                </div>
                <div class="card-body">
                    @{
                        var total = estadisticas?.GetValueOrDefault("Total", 0) ?? 0;
                        var contactados = estadisticas?.GetValueOrDefault("Contactados", 0) ?? 0;
                        var pendientes = estadisticas?.GetValueOrDefault("Pendientes", 0) ?? 0;
                        var porcentajeContactados = total > 0 ? Math.Round((double)contactados / total * 100, 1) : 0;
                        var porcentajePendientes = total > 0 ? Math.Round((double)pendientes / total * 100, 1) : 0;
                    }
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-success fw-bold">Contactados (@contactados)</span>
                            <span class="text-success">@porcentajeContactados%</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: @porcentajeContactados%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-warning fw-bold">Pendientes (@pendientes)</span>
                            <span class="text-warning">@porcentajePendientes%</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-warning" style="width: @porcentajePendientes%"></div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <div class="h4 text-primary">@total</div>
                        <div class="text-muted">Total de Intereses</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas por Período -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-calendar me-2"></i>
                        Estadísticas por Período
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border-end">
                                <div class="h3 text-info">@estadisticas?.GetValueOrDefault("Hoy", 0)</div>
                                <div class="text-muted">Hoy</div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-secondary">@estadisticas?.GetValueOrDefault("EstaSemana", 0)</div>
                            <div class="text-muted">Esta Semana</div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="d-grid gap-2">
                                <a asp-action="Index" asp-route-fechaDesde="@DateTime.Today.ToString("yyyy-MM-dd")" 
                                   class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-calendar-day me-1"></i>
                                    Ver Intereses de Hoy
                                </a>
                                <a asp-action="Index" asp-route-fechaDesde="@DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd")" 
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-calendar-week me-1"></i>
                                    Ver Intereses de esta Semana
                                </a>
                                <a asp-action="Index" asp-route-estado="pendiente" 
                                   class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-clock me-1"></i>
                                    Ver Todos los Pendientes
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-dark text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-bolt me-2"></i>
                        Acciones Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a asp-action="Index" asp-route-estado="pendiente" class="btn btn-warning w-100">
                                <i class="fas fa-clock me-1"></i>
                                Ver Pendientes
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="marcarTodosUrgentesContactados()" class="btn btn-danger w-100">
                                <i class="fas fa-check-double me-1"></i>
                                Marcar Urgentes
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a asp-action="ExportarExcel" class="btn btn-success w-100">
                                <i class="fas fa-file-excel me-1"></i>
                                Exportar Todo
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="location.reload()" class="btn btn-info w-100">
                                <i class="fas fa-sync me-1"></i>
                                Actualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function marcarContactadoRapido(id) {
            if (confirm('¿Marcar este interés como contactado?')) {
                fetch('@Url.Action("MarcarContactado", "InteresInmueble")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: `id=${id}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarMensaje(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        mostrarMensaje(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarMensaje('Error al marcar como contactado', 'error');
                });
            }
        }

        function marcarTodosUrgentesContactados() {
            @if (interesesUrgentes?.Any() == true)
            {
                <text>
                const urgentesIds = [@string.Join(",", interesesUrgentes.Select(u => u.IdInteres))];
                
                if (confirm(`¿Marcar todos los ${urgentesIds.length} intereses urgentes como contactados?`)) {
                    fetch('@Url.Action("MarcarMultiplesContactados", "InteresInmueble")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(urgentesIds)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarMensaje(data.message, 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            mostrarMensaje(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarMensaje('Error al marcar intereses', 'error');
                    });
                }
                </text>
            }
            else
            {
                <text>
                mostrarMensaje('No hay intereses urgentes para marcar', 'info');
                </text>
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            // Crear toast notification
            const toast = $(`
                <div class="toast align-items-center text-white bg-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : tipo === 'warning' ? 'warning' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                            ${mensaje}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);

            // Agregar al container de toasts
            if ($('#toast-container').length === 0) {
                $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }
            
            $('#toast-container').append(toast);
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();

            // Remover después de que se oculte
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

        // Auto-refresh cada 5 minutos
        setInterval(function() {
            // Solo actualizar las estadísticas sin recargar toda la página
            fetch('@Url.Action("ObtenerEstadisticas", "InteresInmueble")')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Estadísticas actualizadas automáticamente');
                    }
                })
                .catch(error => {
                    console.log('Error en actualización automática:', error);
                });
        }, 300000); // 5 minutos
    </script>
}
                            <i class="fas fa-heart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    