@model Inmobiliaria_troncoso_leandro.Models.Contrato
@{
    ViewData["Title"] = "Finalizar Contrato";
}

<div class="row justify-content-center">
    <div class="col-md-10">
        
        <!-- Alerta de confirmación -->
        <div class="alert alert-danger border-danger shadow" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; margin-right: 1rem;"></i>
                <div>
                    <h4 class="alert-heading mb-1">Confirmar Finalización de Contrato</h4>
                    <p class="mb-0">Esta acción finalizará el contrato y liberará el inmueble. Esta operación no se puede deshacer.</p>
                </div>
            </div>
        </div>

        <!-- Información del contrato -->
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h3 class="mb-0">
                    <i class="bi bi-flag-fill"></i> Finalizar Contrato #@Model.IdContrato
                </h3>
            </div>
            <div class="card-body">

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show">
                        <strong>Error:</strong> @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <div class="row">
                    <!-- Información principal del contrato -->
                    <div class="col-md-6">
                        <div class="card border-info h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-file-text"></i> Datos del Contrato</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong class="text-primary">Inmueble:</strong><br>
                                    <span class="h6">@Model.Inmueble?.Direccion</span><br>
                                    <small class="text-muted">
                                        Tipo: @Model.Inmueble?.TipoInmueble?.Nombre | 
                                        Ambientes: @Model.Inmueble?.Ambientes | 
                                        Uso: @Model.Inmueble?.Uso
                                    </small>
                                </div>

                                <div class="mb-3">
                                    <strong class="text-success">Monto Mensual:</strong><br>
                                    <span class="h5 text-success">
                                        @Model.MontoMensual.ToString("C", new System.Globalization.CultureInfo("es-AR"))
                                    </span>
                                </div>

                                <div class="mb-3">
                                    <strong class="text-info">Período:</strong><br>
                                    <span class="badge bg-info">@Model.FechaInicio.ToString("dd/MM/yyyy")</span>
                                    <i class="bi bi-arrow-right mx-2"></i>
                                    <span class="badge bg-warning text-dark">@Model.FechaFin.ToString("dd/MM/yyyy")</span>
                                </div>

                                @{
                                    var duracionOriginal = (Model.FechaFin - Model.FechaInicio).Days;
                                    var hoy = DateTime.Today;
                                    var duracionReal = (hoy - Model.FechaInicio).Days;
                                    var esAnticipado = hoy < Model.FechaFin;
                                }

                                <div class="mb-0">
                                    <strong class="@(esAnticipado ? "text-warning" : "text-success")">Duración:</strong><br>
                                    @if (esAnticipado)
                                    {
                                        <span class="text-warning">
                                            <i class="bi bi-clock-history"></i>
                                            @duracionReal días transcurridos de @duracionOriginal días totales
                                        </span><br>
                                        <small class="text-muted">
                                            Finalización anticipada por @(duracionOriginal - duracionReal) días
                                        </small>
                                    }
                                    else
                                    {
                                        <span class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            @duracionOriginal días (contrato completado)
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de las partes -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-people"></i> Partes Involucradas</h5>
                            </div>
                            <div class="card-body">
                                <!-- Inquilino -->
                                <div class="mb-3">
                                    <strong class="text-primary">
                                        <i class="bi bi-person"></i> Inquilino:
                                    </strong><br>
                                    <span class="h6">@Model.Inquilino?.Usuario?.NombreCompleto</span><br>
                                    <small class="text-muted">
                                        DNI: @Model.Inquilino?.Usuario?.Dni
                                        @if (!string.IsNullOrEmpty(Model.Inquilino?.Usuario?.Telefono))
                                        {
                                            <span> | Tel: @Model.Inquilino.Usuario.Telefono</span>
                                        }
                                    </small>
                                </div>

                                <!-- Propietario -->
                                <div class="mb-3">
                                    <strong class="text-success">
                                        <i class="bi bi-person-badge"></i> Propietario:
                                    </strong><br>
                                    <span class="h6">@Model.Propietario?.Usuario?.NombreCompleto</span><br>
                                    <small class="text-muted">
                                        DNI: @Model.Propietario?.Usuario?.Dni
                                        @if (!string.IsNullOrEmpty(Model.Propietario?.Usuario?.Telefono))
                                        {
                                            <span> | Tel: @Model.Propietario.Usuario.Telefono</span>
                                        }
                                    </small>
                                </div>

                                <!-- Creador -->
                                <div class="mb-0">
                                    <strong class="text-info">
                                        <i class="bi bi-person-check"></i> Creado por:
                                    </strong><br>
                                    <span>@Model.UsuarioCreador?.NombreCompleto</span><br>
                                    <small class="text-muted">
                                        @Model.FechaCreacion.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal para aplicar multa al finalizar -->
<div class="modal fade" id="modalMultaContrato" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Finalizar Contrato
                </h5>
            </div>
            <div class="modal-body">
                <h6>Contrato #@Model.IdContrato terminado el @DateTime.Now.ToString("dd/MM/yyyy")</h6>
                <p><strong>Inquilino:</strong> @Model.Inquilino?.Usuario?.NombreCompleto</p>
                <p><strong>Inmueble:</strong> @Model.Inmueble?.Direccion</p>
                
                <hr>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="aplicarMulta">
                    <label class="form-check-label" for="aplicarMulta">
                        <strong>¿Se aplica multa por daños o condiciones de entrega?</strong>
                    </label>
                </div>
                
                <div id="divMontoMulta" style="display: none;" class="mt-3">
                    <label for="montoMulta" class="form-label">Monto de la multa:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="montoMulta" step="0.01" min="0">
                    </div>
                    <small class="text-muted">Será agregado al último pago mensual</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarModal">
                    Finalizar Contrato
                </button>
            </div>
        </div>
    </div>
</div>

                <!-- Consecuencias de la finalización -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-info-circle"></i> Consecuencias de la finalización:</h6>
                            <ul class="mb-0">
                                <li><strong>Estado del contrato:</strong> Cambiará a "Finalizado" @(esAnticipado ? "Anticipado" : "")</li>
                                <li><strong>Estado del inmueble:</strong> Volverá a "Disponible" para nuevos contratos</li>
                                <li><strong>Fecha de finalización:</strong> Se registrará como @DateTime.Today.ToString("dd/MM/yyyy")</li>
                                @if (esAnticipado)
                                {
                                    <li><strong>Finalización anticipada:</strong> Se marcará la fecha de fin anticipada</li>
                                }
                                <li><strong>Irreversible:</strong> Esta acción no se puede deshacer</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Formulario de confirmación -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="border border-danger rounded p-3 bg-light">
                            <h6 class="text-danger">
                                <i class="bi bi-shield-exclamation"></i> Confirmación requerida
                            </h6>
                            <p class="mb-3">
                                Para finalizar este contrato, confirme que comprende las consecuencias y que tiene
                                autorización para realizar esta acción.
                            </p>
                            
                            <form asp-action="Delete" method="post" class="d-inline">
                                <input type="hidden" asp-for="IdContrato" />
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="checkboxConfirmar" required>
                                    <label class="form-check-label text-danger fw-bold" for="checkboxConfirmar">
                                        Confirmo que deseo finalizar este contrato definitivamente
                                    </label>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="submit" 
                                            class="btn btn-danger btn-lg" 
                                            id="btnFinalizar"
                                            disabled>
                                        <i class="bi bi-flag-fill"></i> Sí, Finalizar Contrato
                                    </button>
                                    <a asp-action="Details" asp-route-id="@Model.IdContrato" 
                                       class="btn btn-secondary btn-lg">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                    <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                                        <i class="bi bi-arrow-left"></i> Volver al Listado
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                @if (Model.MultaAplicada > 0)
                {
                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-exclamation-circle"></i> Multa pendiente:</h6>
                        <p class="mb-0">
                            Este contrato tiene una multa aplicada de <strong>@Model.MultaAplicada.ToString("C", new System.Globalization.CultureInfo("es-AR"))</strong>.
                            Asegúrese de que haya sido gestionada apropiadamente antes de finalizar.
                        </p>
                    </div>
                }

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxConfirmar = document.getElementById('checkboxConfirmar'); 
    const btnFinalizar = document.getElementById('btnFinalizar');
    const btnConfirmarModal = document.getElementById('btnConfirmarModal'); 
    // Habilitar/deshabilitar botón según checkbox
    checkboxConfirmar.addEventListener('change', function() {
        btnFinalizar.disabled = !this.checked;
        console.log('Checkbox cambiado:', this.checked); // Para debug
    });

    // Al hacer clic en "Finalizar Contrato", mostrar modal
    btnFinalizar.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Botón finalizar presionado, checkbox:', checkboxConfirmar.checked); // Para debug
        
        if (checkboxConfirmar.checked) {
            $('#modalMultaContrato').modal('show');
        } else {
            alert('Debe confirmar la finalización marcando la casilla');
        }
    });

    // Mostrar/ocultar campo de multa en el modal
    $('#aplicarMulta').on('change', function() {
        $('#divMontoMulta').toggle(this.checked);
        if (this.checked) {
            $('#montoMulta').focus();
        }
    });

    // Confirmar finalización con o sin multa desde el modal
    btnConfirmarModal.addEventListener('click', function() { // CAMBIADO
        const aplicarMulta = $('#aplicarMulta').is(':checked');
        const montoMulta = aplicarMulta ? parseFloat($('#montoMulta').val()) || 0 : 0;

        // Validar monto si se aplica multa
        if (aplicarMulta && montoMulta <= 0) {
            alert('Por favor, ingrese un monto válido para la multa.');
            $('#montoMulta').focus();
            return;
        }

        // Confirmar la acción
        const mensaje = aplicarMulta 
            ? `¿Confirma finalizar el contrato con una multa de $${montoMulta.toFixed(2)}?`
            : '¿Confirma finalizar el contrato sin multa?';

        if (confirm(mensaje)) {
            // Mostrar loading
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Finalizando...';

            // Enviar al controller
            $.post('@Url.Action("FinalizarConMulta", "Contratos")', {
                id: @Model.IdContrato,
                multaAplicada: montoMulta,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(response) {
                if (response.success) {
                    const mensajeExito = aplicarMulta 
                        ? `Contrato finalizado exitosamente con multa de $${montoMulta.toFixed(2)}`
                        : 'Contrato finalizado exitosamente';
                        
                    alert(mensajeExito);
                    window.location.href = '@Url.Action("Index", "Contratos")';
                } else {
                    alert('Error: ' + (response.error || 'No se pudo finalizar el contrato'));
                    btnConfirmarModal.disabled = false;
                    btnConfirmarModal.innerHTML = 'Finalizar Contrato';
                }
            })
            .fail(function() {
                alert('Error de conexión. Intente nuevamente.');
                btnConfirmarModal.disabled = false;
                btnConfirmarModal.innerHTML = 'Finalizar Contrato';
            });
        }
    });
});
</script>
    
    <style>
        .alert-danger {
            border-left: 5px solid #dc3545;
        }
        
        .card-header {
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .border-danger {
            border-width: 2px !important;
        }
        
        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .form-check-label {
            cursor: pointer;
            user-select: none;
        }
        
        .bg-light {
            background-color: #f8f9fa !important;
        }

        /* Estilos para el modal */
        .modal-header.bg-warning {
            border-bottom: 3px solid rgba(0,0,0,0.1);
        }
        
        #montoMulta:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
    </style>
}