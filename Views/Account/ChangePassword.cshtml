@{
    ViewData["Title"] = "Cambiar Contraseña";
    // Layout dinámico según el rol del usuario
    switch (User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value?.ToLower())
    {
        case "administrador":
            Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
            break;
        case "empleado":
            Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
            break;
        case "propietario":
            Layout = "~/Views/Shared/_LayoutPropietario.cshtml";
            break;
        case "inquilino":
            Layout = "~/Views/Shared/_LayoutInquilino.cshtml";
            break;
        default:
            Layout = "~/Views/Shared/_Layout.cshtml";
            break;
    }
}

<div class="container-fluid">
    <!-- Header de la página -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-key"></i> Cambiar Contraseña
        </h1>
        <a asp-controller="Usuario" asp-action="Perfil" class="btn btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Volver al Perfil
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-6 col-lg-8 col-md-10">
            <!-- Tarjeta principal -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-shield-alt"></i> Actualizar Contraseña
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Mostrar errores de validación -->
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Error:</strong>
                            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <div>@error.ErrorMessage</div>
                            }
                        </div>
                    }

                    <!-- Mostrar mensajes de TempData -->
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            @TempData["Error"]
                        </div>
                    }

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle"></i>
                            @TempData["Success"]
                        </div>
                    }

                    <!-- Información de seguridad -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Recomendaciones de seguridad:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Use al menos 8 caracteres</li>
                            <li>Combine letras mayúsculas y minúsculas</li>
                            <li>Incluya números y símbolos</li>
                            <li>Evite información personal</li>
                        </ul>
                    </div>

                    <form method="post" asp-action="ChangePassword" id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label font-weight-bold">Contraseña Actual *</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <i class="fas fa-lock text-gray-500"></i>
                                    </div>
                                </div>
                                <input type="password" 
                                       class="form-control" 
                                       id="currentPassword" 
                                       name="currentPassword"
                                       placeholder="Ingrese su contraseña actual"
                                       required
                                       autocomplete="current-password">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('currentPassword', 'currentToggleIcon')">
                                        <i class="fas fa-eye" id="currentToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">Ingrese su contraseña actual para confirmar su identidad</small>
                        </div>

                        <div class="form-group">
                            <label for="newPassword" class="form-label font-weight-bold">Nueva Contraseña *</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <i class="fas fa-key text-gray-500"></i>
                                    </div>
                                </div>
                                <input type="password" 
                                       class="form-control" 
                                       id="newPassword" 
                                       name="newPassword"
                                       placeholder="Ingrese su nueva contraseña"
                                       required
                                       autocomplete="new-password"
                                       minlength="6">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword', 'newToggleIcon')">
                                        <i class="fas fa-eye" id="newToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="passwordStrengthText" class="text-muted">Fortaleza de la contraseña</small>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="form-label font-weight-bold">Confirmar Nueva Contraseña *</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <i class="fas fa-check-circle text-gray-500"></i>
                                    </div>
                                </div>
                                <input type="password" 
                                       class="form-control" 
                                       id="confirmPassword" 
                                       name="confirmPassword"
                                       placeholder="Confirme su nueva contraseña"
                                       required
                                       autocomplete="new-password">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword', 'confirmToggleIcon')">
                                        <i class="fas fa-eye" id="confirmToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <small id="passwordMatchText" class="text-muted">Las contraseñas deben coincidir</small>
                        </div>

                        <hr>

                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                                <i class="fas fa-save"></i> Cambiar Contraseña
                            </button>
                            <a asp-controller="Usuario" asp-action="Perfil" class="btn btn-secondary btn-lg ml-2">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar de información -->
        <div class="col-xl-4 col-lg-4 col-md-6">
            <!-- Consejos de seguridad -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-shield-alt"></i> Consejos de Seguridad
                    </h6>
                </div>
                <div class="card-body">
                    <div class="security-tip mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success mt-1 mr-2"></i>
                            <div>
                                <strong>Longitud mínima</strong><br>
                                <small class="text-muted">Use al menos 8 caracteres para mayor seguridad</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-tip mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success mt-1 mr-2"></i>
                            <div>
                                <strong>Combinación de caracteres</strong><br>
                                <small class="text-muted">Mayúsculas, minúsculas, números y símbolos</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-tip mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success mt-1 mr-2"></i>
                            <div>
                                <strong>Evite datos personales</strong><br>
                                <small class="text-muted">No use nombres, fechas o información fácil de adivinar</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-tip mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success mt-1 mr-2"></i>
                            <div>
                                <strong>Unicidad</strong><br>
                                <small class="text-muted">Use una contraseña diferente para cada cuenta</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del usuario - Datos desde ViewBag -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-user-circle"></i> Información de la Cuenta
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="user-avatar mb-2">
                            <div class="bg-gradient-primary rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <span class="text-white font-weight-bold" id="userInitials">
                                    US
                                </span>
                            </div>
                        </div>
                        <h6 class="mb-1" id="userName">Usuario del Sistema</h6>
                        <p class="text-muted small mb-2" id="userEmail">usuario@sistema.com</p>
                        <span class="badge badge-secondary" id="userRole">USUARIO</span>
                    </div>
                    
                    <hr>
                    
                    <div class="small text-muted">
                        <p class="mb-2">
                            <i class="fas fa-clock"></i>
                            <strong>Última actualización:</strong> Nunca
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-info-circle"></i>
                            Es recomendable cambiar la contraseña cada 90 días.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Ayuda adicional -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-question-circle"></i> ¿Necesitas Ayuda?
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Si tienes problemas para cambiar tu contraseña o no recuerdas tu contraseña actual, contacta al administrador.
                    </p>
                    
                    <div class="text-center">
                        <a href="mailto:admin@inmobiliaria.com?subject=Problema con contraseña" class="btn btn-outline-warning btn-sm mb-2">
                            <i class="fas fa-envelope"></i> Contactar Admin
                        </a>
                        <br>
                        <button type="button" class="btn btn-outline-info btn-sm" data-toggle="modal" data-target="#helpModal">
                            <i class="fas fa-question"></i> Más Ayuda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de ayuda -->
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">
                    <i class="fas fa-question-circle"></i> Ayuda - Cambio de Contraseña
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="helpAccordion">
                    <div class="card">
                        <div class="card-header" id="headingOne">
                            <h2 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne">
                                    ¿Olvidé mi contraseña actual?
                                </button>
                            </h2>
                        </div>
                        <div id="collapseOne" class="collapse show" data-parent="#helpAccordion">
                            <div class="card-body">
                                Si no recuerdas tu contraseña actual, contacta al administrador del sistema para que pueda resetearla.
                                <strong>Email:</strong> admin@inmobiliaria.com
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header" id="headingTwo">
                            <h2 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo">
                                    ¿Qué hace una contraseña segura?
                                </button>
                            </h2>
                        </div>
                        <div id="collapseTwo" class="collapse" data-parent="#helpAccordion">
                            <div class="card-body">
                                <ul>
                                    <li>Al menos 8 caracteres de longitud</li>
                                    <li>Combina mayúsculas y minúsculas</li>
                                    <li>Incluye números (0-9)</li>
                                    <li>Contiene símbolos ($!#$%^&*)</li>
                                    <li>No contiene información personal</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header" id="headingThree">
                            <h2 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree">
                                    ¿Con qué frecuencia debo cambiarla?
                                </button>
                            </h2>
                        </div>
                        <div id="collapseThree" class="collapse" data-parent="#helpAccordion">
                            <div class="card-body">
                                Se recomienda cambiar la contraseña cada 90 días o inmediatamente si sospechas que puede haber sido comprometida.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Los datos del usuario serán actualizados desde el controlador
            // mediante ViewBag que se pasará al JavaScript
            
            // Validación en tiempo real de la nueva contraseña
            $('#newPassword').on('input', function() {
                checkPasswordStrength();
                checkPasswordMatch();
            });

            // Validación de coincidencia de contraseñas
            $('#confirmPassword').on('input', function() {
                checkPasswordMatch();
            });

            // Validación del formulario al enviar
            $('#changePasswordForm').submit(function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }
                
                // Mostrar loading
                $('#submitButton').html('<i class="fas fa-spinner fa-spin"></i> Cambiando contraseña...').prop('disabled', true);
            });
        });

        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function checkPasswordStrength() {
            const password = $('#newPassword').val();
            const strengthBar = $('#passwordStrength');
            const strengthText = $('#passwordStrengthText');
            
            let score = 0;
            let feedback = '';
            
            if (password.length >= 8) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            
            switch (score) {
                case 0:
                case 1:
                    strengthBar.removeClass().addClass('progress-bar bg-danger').css('width', '20%');
                    feedback = 'Muy débil';
                    break;
                case 2:
                    strengthBar.removeClass().addClass('progress-bar bg-warning').css('width', '40%');
                    feedback = 'Débil';
                    break;
                case 3:
                    strengthBar.removeClass().addClass('progress-bar bg-info').css('width', '60%');
                    feedback = 'Regular';
                    break;
                case 4:
                    strengthBar.removeClass().addClass('progress-bar bg-success').css('width', '80%');
                    feedback = 'Buena';
                    break;
                case 5:
                    strengthBar.removeClass().addClass('progress-bar bg-success').css('width', '100%');
                    feedback = 'Muy fuerte';
                    break;
            }
            
            strengthText.text(`Fortaleza: ${feedback}`).removeClass().addClass(
                score < 3 ? 'text-danger' : score < 4 ? 'text-warning' : 'text-success'
            );
        }

        function checkPasswordMatch() {
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            const matchText = $('#passwordMatchText');
            
            if (confirmPassword === '') {
                matchText.text('Las contraseñas deben coincidir').removeClass().addClass('text-muted');
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchText.text('Las contraseñas coinciden ✓').removeClass().addClass('text-success');
                $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
            } else {
                matchText.text('Las contraseñas no coinciden').removeClass().addClass('text-danger');
                $('#confirmPassword').removeClass('is-valid').addClass('is-invalid');
            }
        }

        function validateForm() {
            const currentPassword = $('#currentPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('danger', 'Todos los campos son obligatorios.');
                return false;
            }
            
            if (newPassword.length < 6) {
                showAlert('danger', 'La nueva contraseña debe tener al menos 6 caracteres.');
                return false;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('danger', 'Las contraseñas no coinciden.');
                return false;
            }
            
            if (currentPassword === newPassword) {
                showAlert('warning', 'La nueva contraseña debe ser diferente a la actual.');
                return false;
            }
            
            return true;
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            $('.alert').remove();
            $('.card-body').first().prepend(alertHtml);
        }
    </script>
}

<style>
    .security-tip {
        border-left: 3px solid #28a745;
        padding-left: 10px;
        margin-left: 5px;
    }
    
    .user-avatar {
        transition: transform 0.3s ease;
    }
    
    .user-avatar:hover {
        transform: scale(1.05);
    }
    
    .progress {
        transition: all 0.3s ease;
    }
    
    .form-control.is-valid {
        border-color: #28a745;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.4.42c.15.2.5.2.7-.02L7.7 3.04c.2-.2.2-.5 0-.7l-.42-.42c-.2-.2-.5-.2-.7 0L3.1 5.39l-1.4-1.4c-.2-.2-.5-.2-.7 0l-.42.42c-.2.2-.2.5 0 .7l1.9 1.9z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
</style>