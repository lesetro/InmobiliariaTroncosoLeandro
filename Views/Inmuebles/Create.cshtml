@model Inmobiliaria_troncoso_leandro.Models.Inmueble
@{
    ViewData["Title"] = "Crear Inmueble";
}

<div class="row justify-content-between align-items-center mb-4">
    <div class="col-md-6">
        <h2>üè† Crear Nuevo Inmueble</h2>
    </div>
    <div class="col-md-6 text-end">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Listado
        </a>
    </div>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>‚ùå Error:</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <h6><i class="bi bi-exclamation-triangle"></i> Se encontraron errores:</h6>
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

<div class="card">
    <div class="card-body">
        <form asp-action="Create" method="post" enctype="multipart/form-data">
            <div class="row">
                <!-- Columna Izquierda: Datos B√°sicos -->
                <div class="col-lg-6">
                    <h5 class="text-primary mb-3">üìã Informaci√≥n B√°sica</h5>
                    
                    <!-- Direcci√≥n -->
                    <div class="mb-3">
                        <label asp-for="Direccion" class="form-label fw-bold">
                            <i class="bi bi-geo-alt"></i> Direcci√≥n *
                        </label>
                        <input asp-for="Direccion" class="form-control" placeholder="Ej: Av. San Mart√≠n 1234, Villa Mercedes" required>
                        <span asp-validation-for="Direccion" class="text-danger"></span>
                    </div>

                    <!-- Propietario con b√∫squeda -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-person"></i> Propietario *
                        </label>
                        <div class="position-relative">
                            <input type="text" 
                                   id="propietarioBuscar" 
                                   class="form-control" 
                                   placeholder="Buscar propietario (m√≠n. 3 caracteres)..."
                                   autocomplete="off">
                            <input type="hidden" asp-for="IdPropietario" id="propietarioId" required>
                            <div id="propietarioDropdown" 
                                 class="position-absolute w-100 bg-white border shadow-sm"
                                 style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                            </div>
                        </div>
                        <div id="propietarioSeleccionado" class="mt-2 p-2 bg-light rounded" style="display: none;">
                            <small class="text-muted">Propietario seleccionado:</small>
                            <div id="propietarioInfo" class="fw-bold"></div>
                            <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="limpiarPropietario()">
                                <i class="bi bi-x"></i> Cambiar
                            </button>
                        </div>
                        <span asp-validation-for="IdPropietario" class="text-danger"></span>
                    </div>

                    <!-- Tipo de Inmueble -->
                    <div class="mb-3">
                        <label asp-for="IdTipoInmueble" class="form-label fw-bold">
                            <i class="bi bi-building"></i> Tipo de Inmueble *
                        </label>
                        <select asp-for="IdTipoInmueble" class="form-select" id="tipoInmuebleSelect" required>
                            <option value="">Seleccionar tipo...</option>
                        </select>
                        <span asp-validation-for="IdTipoInmueble" class="text-danger"></span>
                    </div>

                    <!-- Uso y Ambientes -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Uso" class="form-label fw-bold">
                                <i class="bi bi-briefcase"></i> Uso *
                            </label>
                            <select asp-for="Uso" class="form-select" required>
                                <option value="">Seleccionar uso...</option>
                                <option value="Residencial">Residencial</option>
                                <option value="Comercial">Comercial</option>
                                <option value="Industrial">Industrial</option>
                                <option value="Mixto">Mixto</option>
                            </select>
                            <span asp-validation-for="Uso" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Ambientes" class="form-label fw-bold">
                                <i class="bi bi-door-open"></i> Ambientes *
                            </label>
                            <input asp-for="Ambientes" class="form-control" type="number" min="1" max="20" required>
                            <span asp-validation-for="Ambientes" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Precio -->
                    <div class="mb-3">
                        <label asp-for="Precio" class="form-label fw-bold">
                            <i class="bi bi-currency-dollar"></i> Precio de Alquiler (ARS) *
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input asp-for="Precio" class="form-control" type="number" step="0.01" min="1" required>
                        </div>
                        <span asp-validation-for="Precio" class="text-danger"></span>
                    </div>

                    <!-- Coordenadas -->
                    <div class="mb-3">
                        <label asp-for="Coordenadas" class="form-label fw-bold">
                            <i class="bi bi-geo"></i> Coordenadas GPS <span class="badge bg-secondary">Opcional</span>
                        </label>
                        <div class="input-group">
                            <input asp-for="Coordenadas" class="form-control" placeholder="-33.682234,-65.463613">
                            <button type="button" class="btn btn-outline-secondary" onclick="abrirGoogleMaps()">
                                <i class="bi bi-map"></i> Google Maps
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Formato: latitud,longitud. 
                            <a href="https://www.google.com/maps" target="_blank" class="text-decoration-none">
                                Obtener en Google Maps
                            </a>
                        </small>
                        <span asp-validation-for="Coordenadas" class="text-danger"></span>
                    </div>
                </div>

                <!-- Columna Derecha: Imagen de Portada -->
                <div class="col-lg-6">
                    <h5 class="text-success mb-3">üñºÔ∏è Imagen de Portada</h5>
                    
                    <!-- Subir imagen de portada -->
                    <div class="mb-3">
                        <label asp-for="PortadaFile" class="form-label fw-bold">
                            <i class="bi bi-camera"></i> Seleccionar Imagen de Portada
                        </label>
                        <input asp-for="PortadaFile" class="form-control" type="file" accept="image/*" id="portadaInput">
                        <small class="form-text text-muted">
                            Formatos: JPG, PNG, GIF (m√°ximo 5MB). Esta ser√° la imagen principal del inmueble.
                        </small>
                        <span asp-validation-for="PortadaFile" class="text-danger"></span>
                    </div>

                    <!-- Vista previa de portada -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Vista previa:</label>
                        <div id="portadaPreview" class="border rounded p-3 text-center bg-light" style="min-height: 200px;">
                            <div class="text-muted">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <h6 class="mt-2">Sin imagen seleccionada</h6>
                                <p class="mb-0 small">Seleccione una imagen para previsualizar</p>
                            </div>
                        </div>
                    </div>

                    <!-- Estado -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-flag"></i> Estado Inicial
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="Estado" value="disponible" checked>
                            <label class="form-check-label">
                                <span class="badge bg-success">Disponible</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="Estado" value="Venta" checked>
                            <label class="form-check-label">
                                <span class="badge bg-secondary">Para venta</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <hr class="my-4">
            <div class="text-center">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-save"></i> Crear Inmueble
                </button>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="limpiarFormulario()">
                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar tipos de inmueble al iniciar
            cargarTiposInmueble();
            
            // Configurar b√∫squeda de propietarios
            configurarBusquedaPropietarios();
            
            // Configurar vista previa de imagen
            configurarVistaPrevia();
        });

        // Cargar tipos de inmueble usando SearchService
        async function cargarTiposInmueble() {
            try {
                const response = await fetch('/api/search/tipos-inmuebles?termino=&limite=100');
                const tipos = await response.json();
                
                const select = document.getElementById('tipoInmuebleSelect');
                tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id;
                    option.textContent = tipo.texto;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando tipos de inmueble:', error);
            }
        }

        

        // Configurar b√∫squeda de propietarios
        function configurarBusquedaPropietarios() {
            const input = document.getElementById('propietarioBuscar');
            const dropdown = document.getElementById('propietarioDropdown');
            let timeout;

            input.addEventListener('input', function() {
                clearTimeout(timeout);
                const termino = this.value.trim();

                if (termino.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }

                timeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/search/propietarios?termino=${encodeURIComponent(termino)}&limite=10`);
                        const propietarios = await response.json();
                        mostrarResultadosPropietarios(propietarios);
                    } catch (error) {
                        console.error('Error en b√∫squeda:', error);
                    }
                }, 300);
            });

            // Ocultar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.position-relative')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function mostrarResultadosPropietarios(propietarios) {
            const dropdown = document.getElementById('propietarioDropdown');
            dropdown.innerHTML = '';

            if (propietarios && propietarios.length > 0) {
                propietarios.forEach(propietario => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border-bottom cursor-pointer';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <div><strong>${propietario.texto}</strong></div>
                        <small class="text-muted">DNI: ${propietario.infoAdicional || 'N/A'}</small>
                    `;
                    
                    div.addEventListener('click', () => {
                        seleccionarPropietario(propietario);
                    });
                    
                    dropdown.appendChild(div);
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.innerHTML = '<div class="p-2 text-muted">No se encontraron propietarios</div>';
                dropdown.style.display = 'block';
            }
        }

        function seleccionarPropietario(propietario) {
            document.getElementById('propietarioId').value = propietario.id;
            document.getElementById('propietarioBuscar').value = '';
            document.getElementById('propietarioDropdown').style.display = 'none';
            
            const infoDiv = document.getElementById('propietarioInfo');
            const contenedor = document.getElementById('propietarioSeleccionado');
            
            infoDiv.textContent = propietario.texto;
            contenedor.style.display = 'block';
        }

        function limpiarPropietario() {
            document.getElementById('propietarioId').value = '';
            document.getElementById('propietarioBuscar').value = '';
            document.getElementById('propietarioSeleccionado').style.display = 'none';
        }

        // Configurar vista previa de imagen
        function configurarVistaPrevia() {
            console.log('Probando b√∫squeda de inmuebles...');
            fetch('/api/search/inmuebles?termino=casa&limite=5')
            .then(response => response.json())
            .then(data => {
            console.log('Inmuebles encontrados:', data);
            })
                .catch(error => {
            console.error('Error buscando inmuebles:', error);
            });
            const input = document.getElementById('portadaInput');
            const preview = document.getElementById('portadaPreview');

            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('La imagen es demasiado grande (m√°ximo 5MB)');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;">
                            <div class="mt-2">
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                                </small>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = `
                        <div class="text-muted">
                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                            <h6 class="mt-2">Sin imagen seleccionada</h6>
                            <p class="mb-0 small">Seleccione una imagen para previsualizar</p>
                        </div>
                    `;
                }
            });
        }

        function abrirGoogleMaps() {
            const direccion = document.querySelector('input[name="Direccion"]').value;
            if (direccion) {
                const url = `https://www.google.com/maps/search/${encodeURIComponent(direccion)}`;
                window.open(url, '_blank');
            } else {
                window.open('https://www.google.com/maps', '_blank');
            }
        }

        function limpiarFormulario() {
            if (confirm('¬øEst√° seguro de que desea limpiar el formulario?')) {
                document.querySelector('form').reset();
                limpiarPropietario();
                configurarVistaPrevia(); // Resetear vista previa
            }
        }
    </script>
}