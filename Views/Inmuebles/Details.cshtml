@model Inmobiliaria_troncoso_leandro.Models.Inmueble
@{
    ViewData["Title"] = $"Inmueble #{Model.IdInmueble} - {Model.Direccion}";
    bool tieneImagenes = Model.Imagenes != null && Model.Imagenes.Any();
    var imagenPrincipal = Model.Imagenes?.OrderBy(i => i.Orden).FirstOrDefault();
    bool estaAlquilado = ViewBag.EstaAlquilado ?? false;
    DateTime? fechaFinContrato = ViewBag.FechaFin as DateTime?;
    int totalImagenes = Model.Imagenes?.Count ?? 0;
    int totalInteresados = Model.Intereses?.Count ?? 0;
}

<div class="container-fluid">
    <!-- Breadcrumb de navegación -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-action="Index" class="text-decoration-none">
                    <i class="fas fa-home me-1"></i>Inmuebles
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Inmueble #@Model.IdInmueble
            </li>
        </ol>
    </nav>

    <!-- Mensajes de alerta -->
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Éxito:</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header con información principal -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span class="badge bg-secondary fs-6">#@Model.IdInmueble</span>
                </div>
                <div>
                    <h2 class="mb-1">@Model.Direccion</h2>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge @Model.EstadoBadgeClass">@Model.EstadoParaMostrar</span>
                        <span class="badge bg-info text-dark">@Model.TipoInmueble?.Nombre</span>
                        <span class="badge bg-light text-dark border">@Model.Ambientes ambientes</span>
                        <span class="badge bg-warning text-dark">@Model.Uso</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <h3 class="text-success mb-0">@Model.Precio.ToString("C", new System.Globalization.CultureInfo("es-AR"))</h3>
            <small class="text-muted">por mes</small>
        </div>
    </div>

    <!-- Alertas de estado especiales -->
    @if (estaAlquilado && fechaFinContrato.HasValue)
    {
        <div class="alert alert-warning">
            <i class="fas fa-calendar-alt me-2"></i>
            <strong>Inmueble Alquilado:</strong> El contrato vence el @fechaFinContrato.Value.ToString("dd/MM/yyyy")
        </div>
    }

    <div class="row">
        <!-- Columna izquierda: Información detallada e imágenes -->
        <div class="col-lg-8">
            <!-- Información detallada -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información Detallada
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-5">Dirección:</dt>
                                <dd class="col-sm-7">@Model.Direccion</dd>
                                
                                <dt class="col-sm-5">Tipo:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge bg-info text-dark">@Model.TipoInmueble?.Nombre</span>
                                </dd>
                                
                                <dt class="col-sm-5">Uso:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge @(Model.Uso == "Comercial" ? "bg-warning text-dark" : "bg-primary")">
                                        @Model.Uso
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-5">Ambientes:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge bg-light text-dark border">@Model.Ambientes</span>
                                </dd>
                                
                                <dt class="col-sm-5">Precio Mensual:</dt>
                                <dd class="col-sm-7">
                                    <strong class="text-success fs-5">@Model.Precio.ToString("C", new System.Globalization.CultureInfo("es-AR"))</strong>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-5">Estado:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge @Model.EstadoBadgeClass">@Model.EstadoParaMostrar</span>
                                </dd>
                                
                                <dt class="col-sm-5">Fecha Alta:</dt>
                                <dd class="col-sm-7">@Model.FechaAlta.ToString("dd/MM/yyyy")</dd>
                                
                                @if (estaAlquilado && fechaFinContrato.HasValue)
                                {
                                    <dt class="col-sm-5">Fin Contrato:</dt>
                                    <dd class="col-sm-7">
                                        <span class="text-warning">@fechaFinContrato.Value.ToString("dd/MM/yyyy")</span>
                                    </dd>
                                }
                                
                                @if (!string.IsNullOrEmpty(Model.Coordenadas))
                                {
                                    <dt class="col-sm-5">Ubicación:</dt>
                                    <dd class="col-sm-7">
                                        <a href="https://www.google.com/maps?q=@Model.Coordenadas" 
                                           target="_blank" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-map-marker-alt me-1"></i>Ver en Mapa
                                        </a>
                                    </dd>
                                }
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Imagen de portada o galería -->
            @if (!string.IsNullOrEmpty(Model.UrlPortada))
            {
                <!-- Mostrar imagen de portada -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-image me-2"></i>Imagen de Portada
                        </h5>
                        <a asp-controller="ImagenesInmueble" asp-action="Index" asp-route-idInmueble="@Model.IdInmueble" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-images me-1"></i>Gestionar Galería
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <img src="@Model.UrlPortada" 
                             class="img-fluid w-100" 
                             alt="Imagen principal del inmueble" 
                             style="height: 300px; object-fit: cover;">
                    </div>
                </div>
            }
            else if (tieneImagenes)
            {
                <!-- Mostrar galería si no hay portada pero sí otras imágenes -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-images me-2"></i>Galería de Imágenes
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <a asp-controller="ImagenesInmueble" asp-action="Index" asp-route-idInmueble="@Model.IdInmueble" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-cog me-1"></i>Gestionar
                            </a>
                            <a asp-controller="ImagenesInmueble" asp-action="Create" asp-route-idInmueble="@Model.IdInmueble" 
                               class="btn btn-outline-success">
                                <i class="fas fa-plus me-1"></i>Agregar
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Carousel principal -->
                        <div id="carouselInmueble" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                @foreach (var imagen in Model.Imagenes.OrderBy(i => i.Orden).Select((img, index) => new { img, index }))
                                {
                                    <div class="carousel-item @(imagen.index == 0 ? "active" : "")">
                                        <img src="@imagen.img.Url" 
                                             class="d-block w-100" 
                                             alt="@(imagen.img.Descripcion ?? "Imagen del inmueble")" 
                                             style="height: 300px; object-fit: cover;"
                                             loading="lazy">
                                        @if (!string.IsNullOrEmpty(imagen.img.Descripcion))
                                        {
                                            <div class="carousel-caption d-md-block bg-dark bg-opacity-75 rounded">
                                                <p class="mb-0">@imagen.img.Descripcion</p>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                            
                            @if (Model.Imagenes.Count() > 1)
                            {
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselInmueble" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Anterior</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselInmueble" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Siguiente</span>
                                </button>
                            }
                        </div>

                        <!-- Thumbnails -->
                        @if (Model.Imagenes.Count() > 1)
                        {
                            <div class="p-3 bg-light">
                                <div class="row g-2">
                                    @foreach (var imagen in Model.Imagenes.OrderBy(i => i.Orden).Select((img, index) => new { img, index }))
                                    {
                                        <div class="col-2">
                                            <img src="@imagen.img.Url" 
                                                 class="img-thumbnail w-100 cursor-pointer thumbnail-img @(imagen.index == 0 ? "active" : "")" 
                                                 style="height: 60px; object-fit: cover;"
                                                 data-bs-target="#carouselInmueble" 
                                                 data-bs-slide-to="@imagen.index"
                                                 alt="Miniatura @(imagen.index + 1)">
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <!-- Sin imágenes -->
                <div class="card mb-4">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-images text-muted mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted">No hay imágenes disponibles</h5>
                        <p class="text-muted mb-3">Agrega algunas imágenes para mostrar mejor este inmueble.</p>
                        <a asp-controller="ImagenesInmueble" asp-action="Create" asp-route-idInmueble="@Model.IdInmueble" 
                           class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Agregar Primera Imagen
                        </a>
                    </div>
                </div>
            }
        </div>

        <!-- Columna derecha: Información del propietario y acciones -->
        <div class="col-lg-4">
            <!-- Información del propietario -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Propietario
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Propietario?.Usuario != null)
                    {
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">@Model.Propietario.Usuario.Apellido, @Model.Propietario.Usuario.Nombre</h6>
                                <small class="text-muted">DNI: @Model.Propietario.Usuario.Dni</small>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.Propietario.Usuario.Telefono))
                        {
                            <div class="mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <a href="tel:@Model.Propietario.Usuario.Telefono" class="text-decoration-none">
                                    @Model.Propietario.Usuario.Telefono
                                </a>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(Model.Propietario.Usuario.Email))
                        {
                            <div class="mb-2">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <a href="mailto:@Model.Propietario.Usuario.Email" class="text-decoration-none">
                                    @Model.Propietario.Usuario.Email
                                </a>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(Model.Propietario.Usuario.Direccion))
                        {
                            <div class="mb-3">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                <small class="text-muted">@Model.Propietario.Usuario.Direccion</small>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted mb-0">Información del propietario no disponible</p>
                    }
                </div>
            </div>

            <!-- Panel de acciones -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Editar inmueble -->
                        <a asp-action="Edit" asp-route-id="@Model.IdInmueble" 
                           class="btn btn-warning">
                            <i class="fas fa-edit me-2"></i>Editar Inmueble
                        </a>
                        
                        <!-- Gestionar imágenes -->
                        <a asp-controller="ImagenesInmueble" asp-action="Index" asp-route-idInmueble="@Model.IdInmueble" 
                           class="btn btn-primary">
                            <i class="fas fa-images me-2"></i>Gestionar Imágenes
                        </a>
                        
                        <!-- Crear contrato -->
                        @if (Model.Estado == "disponible")
                        {
                            <a asp-controller="Contratos" asp-action="Create" asp-route-idInmueble="@Model.IdInmueble" 
                               class="btn btn-success">
                                <i class="fas fa-file-contract me-2"></i>Crear Contrato
                            </a>
                        }
                        
                        <!-- Ver contratos -->
                        <a asp-controller="Contratos" asp-action="Index" asp-route-idInmueble="@Model.IdInmueble" 
                           class="btn btn-info">
                            <i class="fas fa-list me-2"></i>Ver Contratos
                        </a>
                        
                        <!-- Ver en mapa -->
                        <button type="button" class="btn btn-outline-info" onclick="verEnMapa()">
                            <i class="fas fa-map me-2"></i>Ver en Mapa
                        </button>
                        
                        <hr class="my-2">
                        
                        <!-- Eliminar -->
                        <a asp-action="Delete" asp-route-id="@Model.IdInmueble" 
                           class="btn btn-outline-danger">
                            <i class="fas fa-trash me-2"></i>Eliminar Inmueble
                        </a>
                    </div>
                </div>
            </div>

            <!-- Estadísticas rápidas -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Estadísticas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-images text-primary fa-2x"></i>
                            </div>
                            <div class="fw-bold">@totalImagenes</div>
                            <small class="text-muted">Imágenes</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-calendar-check text-success fa-2x"></i>
                            </div>
                            <div class="fw-bold">@((DateTime.Now - Model.FechaAlta).Days)</div>
                            <small class="text-muted">Días activo</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-heart text-danger fa-2x"></i>
                            </div>
                            <div class="fw-bold">@totalInteresados</div>
                            <small class="text-muted">Interesados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de navegación -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver a la Lista
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Gestión de thumbnails activos
            const thumbnails = document.querySelectorAll('.thumbnail-img');
            const carousel = document.getElementById('carouselInmueble');
            
            if (carousel) {
                carousel.addEventListener('slide.bs.carousel', function (e) {
                    thumbnails.forEach(thumb => thumb.classList.remove('active'));
                    if (thumbnails[e.to]) {
                        thumbnails[e.to].classList.add('active');
                    }
                });
            }
        });

        function verEnMapa() {
            @if (!string.IsNullOrEmpty(Model.Coordenadas))
            {
                <text>
                window.open('https://www.google.com/maps?q=@Model.Coordenadas', '_blank');
                </text>
            }
            else
            {
                <text>
                const direccion = encodeURIComponent('@Model.Direccion');
                window.open(`https://www.google.com/maps/search/${direccion}`, '_blank');
                </text>
            }
        }
    </script>
}

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    
    .thumbnail-img.active {
        border: 3px solid #0d6efd;
    }
</style>