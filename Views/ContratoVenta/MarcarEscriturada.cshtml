@model Inmobiliaria_troncoso_leandro.Models.ContratoVenta
@{
    ViewData["Title"] = "Marcar Contrato como Escriturado";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-success">
                    <i class="bi bi-building-check"></i> @ViewData["Title"]
                </h2>
                <div>
                    <a asp-action="Details" asp-route-id="@Model.IdContratoVenta" class="btn btn-outline-info">
                        <i class="bi bi-eye"></i> Ver Detalles
                    </a>
                    <a asp-controller="Contratos" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>

            <!-- Alerta de confirmación -->
            <div class="alert alert-success border-start border-5 border-success">
                <h5 class="alert-heading">
                    <i class="bi bi-check-circle"></i> Confirmar Escrituración
                </h5>
                <p class="mb-2">
                    Esta acción marcará el contrato como <strong class="text-success">ESCRITURADO</strong>, 
                    indicando que la transferencia de propiedad se completó legalmente.
                </p>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Esta operación requiere permisos de administrador.
                </small>
            </div>

            <!-- Información del contrato -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-text text-primary"></i> Información del Contrato
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID Contrato:</strong> #@Model.IdContratoVenta</p>
                            <p><strong>Inmueble:</strong> @Model.Inmueble?.Direccion</p>
                            <p><strong>Vendedor:</strong> @Model.Vendedor?.Usuario?.NombreCompleto</p>
                            <p><strong>Comprador:</strong> @Model.Comprador?.NombreCompleto</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Precio Total:</strong> $@Model.PrecioTotal.ToString("N2")</p>
                            <p><strong>Monto Pagado:</strong> $@Model.MontoPagado.ToString("N2")</p>
                            <p><strong>Saldo Pendiente:</strong> $@Model.SaldoPendiente.ToString("N2")</p>
                            <p><strong>Estado Actual:</strong> <span class="badge @Model.EstadoBadgeClass">@Model.EstadoDescripcion</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validaciones de estado -->
            @if (Model.PorcentajePagado < 100)
            {
                <div class="alert alert-warning border-start border-5 border-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> Advertencia - Pago Incompleto</h6>
                    <p class="mb-0">
                        El contrato tiene un <strong>@Model.PorcentajePagado.ToString("N1")%</strong> de pago completado. 
                        Se recomienda verificar que todos los pagos estén autorizados antes de proceder con la escrituración.
                    </p>
                </div>
            }
            else
            {
                <div class="alert alert-info border-start border-5 border-info">
                    <h6><i class="bi bi-check-circle"></i> Pago Completado</h6>
                    <p class="mb-0">
                        El contrato está <strong>100% pagado</strong>. Puede proceder con la escrituración.
                    </p>
                </div>
            }

            <!-- Formulario de escrituración -->
            <form asp-action="MarcarEscriturada" method="post" id="escrituraForm">
                <input type="hidden" name="id" value="@Model.IdContratoVenta" />
                
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-check"></i> Datos de la Escrituración
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Fecha de escrituración -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="fechaEscritura" class="form-label fw-bold">
                                        Fecha de Escrituración *
                                    </label>
                                    <input type="date" 
                                           id="fechaEscritura" 
                                           name="fechaEscritura" 
                                           class="form-control" 
                                           value="@DateTime.Today.ToString("yyyy-MM-dd")"
                                           min="@Model.FechaInicio.ToString("yyyy-MM-dd")"
                                           max="@DateTime.Today.ToString("yyyy-MM-dd")"
                                           required />
                                    <small class="form-text text-muted">
                                        Fecha en que se realizó la escritura en el registro de la propiedad.
                                        Mínimo: @Model.FechaInicio.ToString("dd/MM/yyyy")
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Verificaciones Requeridas *</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input verificacion" type="checkbox" id="verificacionPagos" required>
                                        <label class="form-check-label" for="verificacionPagos">
                                            Pagos completos o autorizados
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input verificacion" type="checkbox" id="verificacionDocumentos" required>
                                        <label class="form-check-label" for="verificacionDocumentos">
                                            Documentación legal en orden
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input verificacion" type="checkbox" id="verificacionEscritura" required>
                                        <label class="form-check-label" for="verificacionEscritura">
                                            Escritura realizada en registro
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="form-group mb-0">
                            <label for="observaciones" class="form-label fw-bold">Observaciones (Opcional)</label>
                            <textarea id="observaciones" 
                                      name="observaciones" 
                                      class="form-control" 
                                      rows="2" 
                                      placeholder="Observaciones adicionales sobre el proceso de escrituración..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="card mt-4 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-success btn-lg" id="btnConfirmar" disabled>
                                    <i class="bi bi-building-check"></i> Confirmar Escrituración
                                </button>
                                <a asp-action="Details" asp-route-id="@Model.IdContratoVenta" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                            </div>
                            
                            <div class="text-end">
                                <small class="text-muted d-block">
                                    <i class="bi bi-shield-check"></i> Requiere permisos de administrador
                                </small>
                                <small class="text-muted">
                                    Estado final: <span class="badge bg-dark">ESCRITURADO</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('escrituraForm');
            const btnConfirmar = document.getElementById('btnConfirmar');
            const fechaEscritura = document.getElementById('fechaEscritura');
            const verificaciones = document.querySelectorAll('.verificacion');

            // Validar fecha mínima
            fechaEscritura.addEventListener('change', function() {
                const fechaMinima = new Date('@Model.FechaInicio.ToString("yyyy-MM-dd")');
                const fechaSeleccionada = new Date(this.value);
                
                if (fechaSeleccionada < fechaMinima) {
                    alert('Error: La fecha de escritura no puede ser anterior al inicio del contrato (@Model.FechaInicio.ToString("dd/MM/yyyy"))');
                    this.value = '@DateTime.Today.ToString("yyyy-MM-dd")';
                }
            });

            // Habilitar/deshabilitar botón según verificaciones
            function actualizarBoton() {
                const todasVerificadas = Array.from(verificaciones).every(check => check.checked);
                btnConfirmar.disabled = !todasVerificadas;
            }

            verificaciones.forEach(check => {
                check.addEventListener('change', actualizarBoton);
            });

            // Confirmación final
            form.addEventListener('submit', function(e) {
                if (!confirm('¿ESTÁ SEGURO que desea marcar este contrato como ESCRITURADO?\n\n✅ Esta acción:' +
                           '\n• Cambiará el estado a "ESCRITURADO"' +
                           '\n• Actualizará la fecha de escrituración' +
                           '\n• NO se podrá deshacer fácilmente' +
                           '\n\n¿Continuar?')) {
                    e.preventDefault();
                    return;
                }

                // Mostrar estado de carga
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
            });
        });
    </script>

    <style>
        .card {
            border: none;
            border-radius: 10px;
        }
        
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .alert {
            border: none;
            border-radius: 8px;
        }
        
        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }
        
        .border-start {
            border-left-width: 4px !important;
        }
        
        .badge {
            font-size: 0.8em;
            font-weight: 500;
        }
    </style>
}