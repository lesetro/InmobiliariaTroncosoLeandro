@model Inmobiliaria_troncoso_leandro.Models.Inquilino
@{
    ViewData["Title"] = "Crear Inquilino";
}

<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h3 class="card-title mb-0">
                    <i class="bi bi-person-plus-fill"></i>
                    Crear Nuevo Inquilino
                </h3>
            </div>
            <div class="card-body">
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show">
                        <strong>Error:</strong> @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="Create" class="needs-validation" novalidate>
                    <div asp-validation-summary="All" class="alert alert-danger" style="display:none;"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Usuario.Nombre" class="form-label">
                                    <i class="bi bi-person"></i> Nombre
                                </label>
                                <input asp-for="Usuario.Nombre" class="form-control" placeholder="Ingrese el nombre" />
                                <span asp-validation-for="Usuario.Nombre" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Usuario.Apellido" class="form-label">
                                    <i class="bi bi-person"></i> Apellido
                                </label>
                                <input asp-for="Usuario.Apellido" class="form-control" placeholder="Ingrese el apellido" />
                                <span asp-validation-for="Usuario.Apellido" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Usuario.Dni" class="form-label">
                                    <i class="bi bi-card-text"></i> DNI
                                </label>
                                <input asp-for="Usuario.Dni" class="form-control" placeholder="Ej: 12345678" />
                                <span asp-validation-for="Usuario.Dni" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Usuario.Telefono" class="form-label">
                                    <i class="bi bi-telephone"></i> Teléfono
                                </label>
                                <input asp-for="Usuario.Telefono" class="form-control" placeholder="Ej: 2664123456" />
                                <span asp-validation-for="Usuario.Telefono" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Usuario.Email" class="form-label">
                            <i class="bi bi-envelope"></i> Email
                        </label>
                        <input asp-for="Usuario.Email" type="email" class="form-control" placeholder="ejemplo@correo.com" />
                        <span asp-validation-for="Usuario.Email" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-4">
                        <label asp-for="Usuario.Direccion" class="form-label">
                            <i class="bi bi-geo-alt"></i> Dirección
                        </label>
                        <input asp-for="Usuario.Direccion" class="form-control" placeholder="Calle, número, ciudad" />
                        <span asp-validation-for="Usuario.Direccion" class="text-danger"></span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Crear Inquilino
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // Variables para debounce
            let dniTimeout;
            let emailTimeout;
            let telefonoTimeout;

            // ==========================================
            // VALIDACIÓN DNI CON AJAX
            // ==========================================
            $('#Usuario_Dni').on('input', function() {
                const dni = $(this).val().trim();
                const $input = $(this);
                let $feedback = $input.siblings('.text-danger');
                
                if ($feedback.length === 0) {
                    $input.after('<div class="text-danger small"></div>');
                    $feedback = $input.siblings('.text-danger');
                }
                
                clearTimeout(dniTimeout);
                
                if (dni.length === 0) {
                    $input.removeClass('is-valid is-invalid');
                    $feedback.text('');
                    return;
                }
                
                if (!/^\d{7,8}$/.test(dni)) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    $feedback.text('El DNI debe contener entre 7 y 8 números');
                    return;
                }
                
                dniTimeout = setTimeout(function() {
                    verificarDniExistente(dni);
                }, 500);
            });
            
            function verificarDniExistente(dni) {
                const $input = $('#Usuario_Dni');
                let $feedback = $input.siblings('.text-danger');
                
                $input.prop('disabled', true);
                
                $.ajax({
                    url: '/Usuario/VerificarDni',
                    method: 'GET',
                    data: { dni: dni },
                    dataType: 'json',
                    success: function(response) {
                        console.log('DNI - Respuesta:', response);
                        
                        if (response.existe) {
                            $input.removeClass('is-valid').addClass('is-invalid');
                            $feedback.text(response.mensaje || 'Este DNI ya está registrado en el sistema');
                        } else {
                            $input.removeClass('is-invalid').addClass('is-valid');
                            $feedback.text('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error verificando DNI:', error);
                        $input.removeClass('is-invalid').addClass('is-valid');
                        $feedback.text('');
                    },
                    complete: function() {
                        $input.prop('disabled', false);
                    }
                });
            }
            
            // ==========================================
            // VALIDACIÓN EMAIL CON AJAX
            // ==========================================
            $('#Usuario_Email').on('input', function() {
                const email = $(this).val().trim();
                const $input = $(this);
                const emailRegex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                let $feedback = $input.siblings('.text-danger');
                
                if ($feedback.length === 0) {
                    $input.after('<div class="text-danger small"></div>');
                    $feedback = $input.siblings('.text-danger');
                }
                
                clearTimeout(emailTimeout);
                
                if (email.length === 0) {
                    $input.removeClass('is-valid is-invalid');
                    $feedback.text('');
                    return;
                }
                
                if (!emailRegex.test(email)) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    $feedback.text('Por favor ingrese un email válido');
                    return;
                }
                
                emailTimeout = setTimeout(function() {
                    verificarEmailExistente(email);
                }, 500);
            });
            
            function verificarEmailExistente(email) {
                const $input = $('#Usuario_Email');
                let $feedback = $input.siblings('.text-danger');
                
                $.ajax({
                    url: '/Usuario/VerificarEmail',
                    method: 'GET',
                    data: { email: email },
                    dataType: 'json',
                    success: function(response) {
                        console.log('Email - Respuesta:', response);
                        
                        if (response.existe) {
                            $input.removeClass('is-valid').addClass('is-invalid');
                            $feedback.text(response.mensaje || 'Este email ya está registrado en el sistema');
                        } else {
                            $input.removeClass('is-invalid').addClass('is-valid');
                            $feedback.text('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error verificando email:', error);
                        $input.removeClass('is-invalid').addClass('is-valid');
                        $feedback.text('');
                    }
                });
            }
            
            // ==========================================
            // VALIDACIÓN TELÉFONO CON AJAX
            // ==========================================
            $('#Usuario_Telefono').on('input', function() {
                const telefono = $(this).val().trim();
                const $input = $(this);
                const telefonoRegex = /^[\+]?[0-9]{8,15}$/;
                let $feedback = $input.siblings('.text-danger');
                
                if ($feedback.length === 0) {
                    $input.after('<div class="text-danger small"></div>');
                    $feedback = $input.siblings('.text-danger');
                }
                
                clearTimeout(telefonoTimeout);
                
                if (telefono.length === 0) {
                    $input.removeClass('is-valid is-invalid');
                    $feedback.text('');
                    return;
                }
                
                if (!telefonoRegex.test(telefono)) {
                    $input.removeClass('is-valid').addClass('is-invalid');
                    $feedback.text('Ingrese un teléfono válido (8-15 dígitos)');
                    return;
                }
                
                telefonoTimeout = setTimeout(function() {
                    verificarTelefonoExistente(telefono);
                }, 500);
            });
            
            function verificarTelefonoExistente(telefono) {
                const $input = $('#Usuario_Telefono');
                let $feedback = $input.siblings('.text-danger');
                
                $.ajax({
                    url: '/Usuario/VerificarTelefono',
                    method: 'GET',
                    data: { telefono: telefono },
                    dataType: 'json',
                    success: function(response) {
                        console.log('Teléfono - Respuesta:', response);
                        
                        if (response.existe) {
                            $input.removeClass('is-valid').addClass('is-invalid');
                            $feedback.text(response.mensaje || 'Este teléfono ya está registrado');
                        } else {
                            $input.removeClass('is-invalid').addClass('is-valid');
                            $feedback.text('');
                        }
                    },
                    error: function() {
                        console.error('Error verificando teléfono');
                        $input.removeClass('is-invalid').addClass('is-valid');
                        $feedback.text('');
                    }
                });
            }

            // ==========================================
            // VALIDACIÓN DEL FORMULARIO ANTES DE ENVIAR
            // ==========================================
            $('form').on('submit', function(e) {
                let isValid = true;
                let camposInvalidos = [];
                
                console.log('🔍 Validando formulario antes de enviar...');
                
                // Verificar campos con clase is-invalid
                if ($('#Usuario_Dni').hasClass('is-invalid')) {
                    isValid = false;
                    camposInvalidos.push('DNI');
                    console.log(' DNI inválido');
                }
                
                if ($('#Usuario_Email').hasClass('is-invalid')) {
                    isValid = false;
                    camposInvalidos.push('Email');
                    console.log('Email inválido');
                }
                
                if ($('#Usuario_Telefono').hasClass('is-invalid')) {
                    isValid = false;
                    camposInvalidos.push('Teléfono');
                    console.log(' Teléfono inválido');
                }
                
                // Verificar campos requeridos específicos
                const camposRequeridos = [
                    { selector: '#Usuario_Nombre', nombre: 'Nombre' },
                    { selector: '#Usuario_Apellido', nombre: 'Apellido' },
                    { selector: '#Usuario_Dni', nombre: 'DNI' },
                    { selector: '#Usuario_Email', nombre: 'Email' }
                ];
                
                camposRequeridos.forEach(function(campo) {
                    const $campo = $(campo.selector);
                    const valor = $campo.val();
                    
                    if (!valor || !valor.trim()) {
                        isValid = false;
                        $campo.addClass('is-invalid');
                        camposInvalidos.push(campo.nombre);
                        console.log(' Campo vacío:', campo.nombre);
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    console.log(' Formulario NO válido. Campos con error:', camposInvalidos);
                    
                    // Crear o actualizar alerta
                    let $alert = $('.alert-danger');
                    if ($alert.length === 0) {
                        $('form').prepend(
                            '<div class="alert alert-danger alert-dismissible fade show">' +
                            '<strong>Error:</strong> <span class="mensaje-error"></span>' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                            '</div>'
                        );
                        $alert = $('.alert-danger');
                    }
                    
                    $alert.find('.mensaje-error').text('Por favor corrija los siguientes campos: ' + camposInvalidos.join(', '));
                    $alert.show();
                    
                    // Scroll al primer campo inválido
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                    
                    return false;
                }
                
                console.log('Formulario válido, enviando...');
            });

            // Auto-focus en el primer campo
            const firstInput = document.querySelector('input[name="Usuario.Nombre"]');
            if (firstInput) {
                firstInput.focus();
            }
        });
    </script>
}